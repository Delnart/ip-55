<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å—å–∫–∏–π –ø–æ–º—ñ—á–Ω–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
            background-color: #f9fafb;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = '/api';

        // --- ICONS ---
        const Icons = {
            Home: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Calendar: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Users: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Book: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Clipboard: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>,
            ArrowLeft: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
            Settings: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Info: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            ChevronRight: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
            Trash: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        };

        // --- API UTILS ---
        const api = {
            get: async (url) => {
                const r = await fetch(API_BASE + url);
                if (!r.ok) throw new Error('API Error');
                return r.json();
            },
            post: async (url, data) => {
                const r = await fetch(API_BASE + url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!r.ok) throw new Error('API Error');
                return r.json();
            },
            patch: async (url, data) => {
                const r = await fetch(API_BASE + url, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!r.ok) throw new Error('API Error');
                return r.json();
            },
            delete: async (url) => {
                 const r = await fetch(API_BASE + url, { method: 'DELETE' });
                 if (!r.ok) throw new Error('API Error');
                 return r.json();
            }
        };

        // --- COMPONENTS ---

        function SubjectView({ subject, user, onNavigate, onBack }) {
            return (
                <div className="min-h-screen bg-gray-50 pb-20">
                    <div className="bg-white p-4 shadow-sm sticky top-0 z-10 flex items-center gap-3">
                        <button onClick={onBack} className="p-2 -ml-2 text-gray-600 active:bg-gray-100 rounded-full"><Icons.ArrowLeft /></button>
                        <h1 className="font-bold text-xl truncate">{subject.name}</h1>
                    </div>

                    <div className="p-4 space-y-4">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <div className="flex items-start gap-3 mb-4">
                                <div className="p-3 bg-blue-50 rounded-xl text-blue-600"><Icons.Info /></div>
                                <div>
                                    <p className="text-xs text-gray-400 uppercase font-bold">–õ–µ–∫—Ç–æ—Ä</p>
                                    <p className="font-semibold mb-2">{subject.teacherLecture || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                                    <p className="text-xs text-gray-400 uppercase font-bold">–ü—Ä–∞–∫—Ç–∏–∫</p>
                                    <p className="font-semibold">{subject.teacherPractice || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={() => onNavigate('queue', subject)} 
                                className="p-4 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50 active:scale-95 transition">
                                <div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600">
                                    <Icons.Users />
                                </div>
                                <span className="font-bold text-gray-700">–ß–µ—Ä–≥–∞</span>
                                <span className="text-xs text-gray-400">–ó–¥–∞—á–∞ –ª–∞–±</span>
                            </button>

                            <button onClick={() => onNavigate('topics', subject)}
                                className="p-4 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50 active:scale-95 transition">
                                <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                                    <Icons.Book />
                                </div>
                                <span className="font-bold text-gray-700">–¢–µ–º–∏</span>
                                <span className="text-xs text-gray-400">–†–µ—Ñ–µ—Ä–∞—Ç–∏</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function QueueView({ subject, user, onBack, isAdmin }) {
            const [queue, setQueue] = useState(null);
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [labNum, setLabNum] = useState('');
            const [showConfig, setShowConfig] = useState(false);

            const STATUSES = {
                preparing: { label: '–ì–æ—Ç—É—î—Ç—å—Å—è', color: 'bg-yellow-100 text-yellow-700 border-yellow-200', icon: '‚è∞' },
                defending: { label: '–ó–¥–∞—î', color: 'bg-green-100 text-green-700 border-green-200', icon: '‚ñ∂Ô∏è' },
                completed: { label: '–ó–¥–∞–≤', color: 'bg-blue-100 text-blue-700 border-blue-200', icon: '‚úÖ' },
                failed: { label: '–ù–µ –∑–¥–∞–≤', color: 'bg-red-100 text-red-700 border-red-200', icon: '‚ùå' },
                waiting: { label: '–í —á–µ—Ä–∑—ñ', color: 'bg-white border-gray-200', icon: '' }
            };

            const fetchQueue = async () => {
                try {
                    let data = await api.get(`/queues/subject/${subject._id}`);
                    if (!data) data = await api.post('/queues', { subjectId: subject._id });
                    setQueue(data);
                } catch(e) { console.error(e); }
            };

            useEffect(() => {
                fetchQueue();
                const i = setInterval(fetchQueue, 3000);
                return () => clearInterval(i);
            }, [subject]);

            const handleJoin = async (slot) => {
                if (!labNum) return alert("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó");
                try {
                    await api.post('/queues/join', {
                        queueId: queue._id,
                        telegramId: user.id,
                        labNumber: parseInt(labNum),
                        position: slot
                    });
                    setSelectedSlot(null);
                    setLabNum('');
                    fetchQueue();
                } catch (e) {
                    alert(e.message || "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É (–º–æ–∂–ª–∏–≤–æ –ø–æ—Ä—É—à–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –ú—ñ–Ω+2)");
                }
            };

            const handleStatusChange = async (targetUserId, status) => {
                try {
                    await api.patch('/queues/status', {
                        queueId: queue._id,
                        userId: targetUserId,
                        status,
                        adminId: user.id
                    });
                    fetchQueue();
                    setSelectedSlot(null);
                } catch (e) { alert("–ù–µ–º–∞—î –ø—Ä–∞–≤"); }
            };

            const handleToggle = async () => {
                 await api.post('/queues/toggle', { queueId: queue._id, adminId: user.id });
                 fetchQueue();
            }

            if (!queue) return <div className="p-10 text-center text-gray-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>;

            return (
                <div className="min-h-screen bg-gray-50 pb-20">
                    <div className="bg-white p-4 sticky top-0 z-20 shadow-sm flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <button onClick={onBack}><Icons.ArrowLeft /></button>
                            <div>
                                <h2 className="font-bold leading-none">{subject.name}</h2>
                                <span className={`text-xs font-bold ${queue.isActive ? 'text-green-500' : 'text-red-500'}`}>
                                    {queue.isActive ? 'üü¢ –í—ñ–¥–∫—Ä–∏—Ç–æ' : 'üî¥ –ó–∞–∫—Ä–∏—Ç–æ'}
                                </span>
                            </div>
                        </div>
                        {isAdmin && <button onClick={() => setShowConfig(!showConfig)} className="p-2 bg-gray-100 rounded-full"><Icons.Settings /></button>}
                    </div>

                    {isAdmin && showConfig && (
                        <div className="bg-gray-800 text-white p-4">
                            <h3 className="font-bold text-sm mb-3">–ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                            <button onClick={handleToggle} className={`px-4 py-2 rounded-lg font-bold text-sm w-full ${queue.isActive ? 'bg-red-500' : 'bg-green-500'}`}>
                                {queue.isActive ? 'üîí –ó–∞–∫—Ä–∏—Ç–∏ —á–µ—Ä–≥—É' : 'üîì –í—ñ–¥–∫—Ä–∏—Ç–∏ —á–µ—Ä–≥—É'}
                            </button>
                        </div>
                    )}

                    <div className="p-3 grid grid-cols-3 gap-2">
                        {Array.from({ length: 31 }, (_, i) => i + 1).map(slot => {
                            const entry = queue.entries.find(e => e.position === slot);
                            const statusStyle = entry ? STATUSES[entry.status]?.color : 'border-dashed border-gray-300 bg-gray-50';
                            
                            return (
                                <div key={slot} onClick={() => setSelectedSlot({ slot, entry })}
                                    className={`relative min-h-[100px] rounded-xl border-2 flex flex-col items-center justify-center p-1 transition-all active:scale-95 cursor-pointer ${statusStyle}`}>
                                    
                                    <span className="absolute top-1 left-2 text-[10px] text-gray-400 font-bold">#{slot}</span>
                                    
                                    {entry ? (
                                        <>
                                            <div className="w-8 h-8 rounded-full bg-white mb-1 overflow-hidden shadow-sm flex items-center justify-center text-xs font-bold text-gray-600">
                                                {entry.user?.fullName?.[0]}
                                            </div>
                                            <span className="text-[10px] font-bold text-center leading-tight line-clamp-2 h-6 flex items-center">
                                                {entry.user?.fullName}
                                            </span>
                                            <div className="mt-1 flex items-center gap-1 bg-white/60 px-1.5 rounded-md border border-gray-100">
                                                <span className="text-[10px] font-bold">–õ–∞–± {entry.labNumber}</span>
                                                <span className="text-[10px]">{STATUSES[entry.status]?.icon}</span>
                                            </div>
                                        </>
                                    ) : (
                                        <span className="text-2xl text-gray-300">+</span>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {selectedSlot && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setSelectedSlot(null)}>
                            <div className="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-1">–ú—ñ—Å—Ü–µ #{selectedSlot.slot}</h3>
                                
                                {!selectedSlot.entry ? (
                                    <>
                                        <p className="text-gray-500 mb-4 text-sm">–í—ñ–ª—å–Ω–µ –º—ñ—Å—Ü–µ. –í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó:</p>
                                        <input type="number" className="w-full bg-gray-100 p-3 rounded-xl mb-4 text-center font-bold text-lg" 
                                            value={labNum} onChange={e => setLabNum(e.target.value)} autoFocus placeholder="‚Ññ" />
                                        <button onClick={() => handleJoin(selectedSlot.slot)} 
                                            className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200">
                                            –ó–∞–π–Ω—è—Ç–∏
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <p className="font-bold mb-4 text-center text-lg">{selectedSlot.entry.user?.fullName}</p>
                                        <div className="bg-gray-50 p-3 rounded-xl mb-4 text-center">
                                            <span className="text-sm text-gray-500">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ —Ä–æ–±–æ—Ç–∞</span>
                                            <p className="text-2xl font-bold">‚Ññ{selectedSlot.entry.labNumber}</p>
                                        </div>

                                        {isAdmin ? (
                                            <div className="grid grid-cols-2 gap-2">
                                                {Object.entries(STATUSES).map(([key, val]) => (
                                                    <button key={key} onClick={() => handleStatusChange(selectedSlot.entry.userId, key)}
                                                        className={`p-2 rounded-lg text-xs font-bold border flex flex-col items-center gap-1 ${val.color.replace('bg-', 'hover:bg-')}`}>
                                                        <span className="text-lg">{val.icon}</span> {val.label}
                                                    </button>
                                                ))}
                                                <button onClick={() => api.post('/queues/kick', { queueId: queue._id, targetUserId: selectedSlot.entry.userId, adminTgId: user.id }).then(fetchQueue).then(() => setSelectedSlot(null))} 
                                                    className="col-span-2 mt-2 bg-red-50 text-red-600 py-3 rounded-lg font-bold border border-red-100">
                                                    –í–∏–¥–∞–ª–∏—Ç–∏ –∑ —á–µ—Ä–≥–∏
                                                </button>
                                            </div>
                                        ) : (
                                            selectedSlot.entry.user?.telegramId === user?.id && (
                                                <button onClick={() => api.post('/queues/leave', { queueId: queue._id, telegramId: user.id }).then(() => { fetchQueue(); setSelectedSlot(null); })}
                                                    className="w-full bg-red-100 text-red-600 py-3 rounded-xl font-bold">
                                                    –í–∏–π—Ç–∏ –∑ —á–µ—Ä–≥–∏
                                                </button>
                                            )
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Schedule({ onNavigate }) {
            const [schedule, setSchedule] = useState(null);
            const [week, setWeek] = useState(1);

            useEffect(() => {
                api.get('/schedule').then(setSchedule).catch(() => {});
            }, []);

            if (!schedule) return <div className="p-10 text-center text-gray-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É...</div>;

            const weekKey = week === 1 ? 'scheduleFirstWeek' : 'scheduleSecondWeek';
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const dayNames = { Monday: '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', Tuesday: '–í—ñ–≤—Ç–æ—Ä–æ–∫', Wednesday: '–°–µ—Ä–µ–¥–∞', Thursday: '–ß–µ—Ç–≤–µ—Ä', Friday: "–ü'—è—Ç–Ω–∏—Ü—è" };

            return (
                <div className="p-4 pb-24">
                    <h1 className="text-2xl font-bold mb-4">–†–æ–∑–∫–ª–∞–¥</h1>
                    <div className="flex bg-gray-200 p-1 rounded-xl mb-6">
                        <button onClick={() => setWeek(1)} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${week === 1 ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'}`}>1 –¢–∏–∂–¥–µ–Ω—å</button>
                        <button onClick={() => setWeek(2)} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${week === 2 ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'}`}>2 –¢–∏–∂–¥–µ–Ω—å</button>
                    </div>

                    <div className="space-y-6">
                        {days.map(dayCode => {
                            const dayData = schedule[weekKey].find(d => d.day === dayCode);
                            if (!dayData?.pairs?.length) return null;

                            return (
                                <div key={dayCode} className="animate-in slide-in-from-bottom-2 fade-in duration-500">
                                    <h3 className="text-gray-400 font-bold uppercase text-xs mb-3 tracking-wider pl-1">{dayNames[dayCode]}</h3>
                                    <div className="space-y-3">
                                        {dayData.pairs.map((pair, idx) => {
                                            const isLecture = pair.type.includes('–õ–µ–∫');
                                            const borderColor = isLecture ? 'border-l-purple-500' : 'border-l-orange-500';
                                            const badgeColor = isLecture ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700';

                                            return (
                                                <div key={idx} className={`p-4 rounded-xl border-l-4 ${borderColor} bg-white shadow-sm flex gap-4`}>
                                                    <div className="flex flex-col items-center justify-center min-w-[50px] border-r border-gray-100 pr-4">
                                                        <span className="font-bold text-gray-900 text-sm">{pair.time.substring(0, 5)}</span>
                                                        <span className="text-[10px] text-gray-400 font-medium">–ü–û–ß</span>
                                                    </div>
                                                    <div className="flex-1">
                                                        <span className={`text-[10px] px-2 py-0.5 rounded font-bold uppercase mb-1 inline-block ${badgeColor}`}>
                                                            {pair.type}
                                                        </span>
                                                        <h4 className="font-bold text-gray-800 leading-tight mb-1">{pair.name}</h4>
                                                        <p className="text-xs text-gray-500 font-medium flex items-center gap-1">
                                                            üë®‚Äçüè´ {pair.teacherName}
                                                        </p>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function Home({ user, onNavigate, isAdmin }) {
            const [subjects, setSubjects] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [newSubject, setNewSubject] = useState({ name: '', type: 'exam', teacherLecture: '', teacherPractice: '' });

            const loadSubjects = () => api.get('/subjects').then(setSubjects).catch(console.error);

            useEffect(() => { loadSubjects(); }, []);

            const handleAdd = async () => {
                await api.post('/subjects', newSubject);
                setIsEditing(false);
                loadSubjects();
            };

            const handleDelete = async (id) => {
                if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç?")) {
                    await api.delete(`/subjects/${id}`);
                    loadSubjects();
                }
            }

            return (
                <div className="p-4 pb-24">
                    <div className="flex justify-between items-center mb-6 pt-2">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">–ü—Ä–∏–≤—ñ—Ç, {user?.firstName || '–°—Ç—É–¥–µ–Ω—Ç'}!</h1>
                            <p className="text-gray-500 text-sm">–¢–≤–æ—ó –ø—Ä–µ–¥–º–µ—Ç–∏</p>
                        </div>
                        {isAdmin && (
                            <button onClick={() => setIsEditing(!isEditing)} className={`p-3 rounded-full transition ${isEditing ? 'bg-blue-100 text-blue-600' : 'bg-white shadow-sm text-gray-400'}`}>
                                <Icons.Settings />
                            </button>
                        )}
                    </div>

                    {isEditing && (
                        <div className="bg-white p-4 rounded-2xl shadow-lg mb-6 border border-blue-100 animate-in fade-in slide-in-from-top-4">
                            <h3 className="font-bold mb-3 text-gray-800">–î–æ–¥–∞—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç</h3>
                            <input placeholder="–ù–∞–∑–≤–∞ –ø—Ä–µ–¥–º–µ—Ç—É" className="w-full p-3 bg-gray-50 rounded-xl mb-2 text-sm outline-none focus:ring-2 focus:ring-blue-100" 
                                value={newSubject.name} onChange={e => setNewSubject({...newSubject, name: e.target.value})} />
                            <input placeholder="–õ–µ–∫—Ç–æ—Ä (–ü–Ü–ë)" className="w-full p-3 bg-gray-50 rounded-xl mb-2 text-sm outline-none focus:ring-2 focus:ring-blue-100"
                                value={newSubject.teacherLecture} onChange={e => setNewSubject({...newSubject, teacherLecture: e.target.value})} />
                             <input placeholder="–ü—Ä–∞–∫—Ç–∏–∫ (–ü–Ü–ë)" className="w-full p-3 bg-gray-50 rounded-xl mb-3 text-sm outline-none focus:ring-2 focus:ring-blue-100"
                                value={newSubject.teacherPractice} onChange={e => setNewSubject({...newSubject, teacherPractice: e.target.value})} />
                            <button onClick={handleAdd} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                        </div>
                    )}

                    <div className="space-y-3">
                        {subjects.map(subject => (
                            <div key={subject._id} onClick={() => onNavigate('subject', subject)}
                                className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 active:scale-[0.98] transition-transform cursor-pointer flex justify-between items-center group">
                                <div>
                                    <h3 className="font-bold text-gray-800 mb-1">{subject.name}</h3>
                                    <p className="text-xs text-gray-500 flex items-center gap-1">
                                        üéì {subject.teacherLecture || '–í–∏–∫–ª–∞–¥–∞—á –Ω–µ –≤–∫–∞–∑–∞–Ω–∏–π'}
                                    </p>
                                </div>
                                <div className="flex items-center gap-2">
                                     {isEditing && (
                                         <button onClick={(e) => { e.stopPropagation(); handleDelete(subject._id); }} className="p-2 text-red-400 hover:bg-red-50 rounded-full">
                                            <Icons.Trash />
                                         </button>
                                     )}
                                    <div className="w-8 h-8 bg-gray-50 rounded-full flex items-center justify-center group-hover:bg-blue-50 group-hover:text-blue-600 transition">
                                        <Icons.ChevronRight />
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('home');
            const [stack, setStack] = useState([]);
            const [user, setUser] = useState(null);
            
            // –í—Å—Ç–∞–≤ —Å—é–¥–∏ —Å–≤—ñ–π ID –¥–ª—è –∞–¥–º—ñ–Ω–∫–∏, –∞–±–æ –±–µ–∫–µ–Ω–¥ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
            const ADMIN_IDS = [597257008]; 
            const isAdmin = user && ADMIN_IDS.includes(user.id);

            useEffect(() => {
                const tg = window.Telegram?.WebApp;
                if (tg) {
                    tg.ready();
                    tg.expand();
                    const u = tg.initDataUnsafe?.user;
                    if(u) {
                        setUser({
                            id: u.id,
                            firstName: u.first_name,
                            lastName: u.last_name,
                            username: u.username
                        });
                        // Sync user to DB
                        api.post('/users/update', { 
                            telegramId: u.id, 
                            fullName: `${u.first_name} ${u.last_name || ''}`.trim(), 
                            username: u.username 
                        }).catch(console.error);
                    }
                }
                
                // URL params handling
                const params = new URLSearchParams(window.location.search);
                const t = params.get('tab');
                if (t && ['home', 'schedule', 'homework'].includes(t)) setView(t);
            }, []);

            const navigate = (viewName, data = null) => setStack([...stack, { view: viewName, data }]);
            const goBack = () => setStack(stack.slice(0, -1));

            const current = stack.length > 0 ? stack[stack.length - 1] : { view };

            const renderView = () => {
                switch (current.view) {
                    case 'home': return <Home user={user} onNavigate={navigate} isAdmin={isAdmin} />;
                    case 'schedule': return <Schedule onNavigate={navigate} />;
                    case 'homework': return <div className="p-10 text-center">–í —Ä–æ–∑—Ä–æ–±—Ü—ñ...</div>;
                    case 'subject': return <SubjectView subject={current.data} user={user} onNavigate={navigate} onBack={goBack} />;
                    case 'queue': return <QueueView subject={current.data} user={user} onBack={goBack} isAdmin={isAdmin} />;
                    case 'topics': return <div className="p-10 text-center"> <button onClick={goBack}>–ù–∞–∑–∞–¥</button><br/>–í —Ä–æ–∑—Ä–æ–±—Ü—ñ...</div>;
                    default: return <Home user={user} onNavigate={navigate} isAdmin={isAdmin} />;
                }
            };

            const showNav = stack.length === 0;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 font-sans text-gray-900">
                    {renderView()}
                    
                    {showNav && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 pb-6 safe-area-bottom z-50">
                            <NavBtn icon={<Icons.Home />} label="–ü—Ä–µ–¥–º–µ—Ç–∏" active={view === 'home'} onClick={() => setView('home')} />
                            <NavBtn icon={<Icons.Calendar />} label="–†–æ–∑–∫–ª–∞–¥" active={view === 'schedule'} onClick={() => setView('schedule')} />
                            <NavBtn icon={<Icons.Clipboard />} label="–î–ó" active={view === 'homework'} onClick={() => setView('homework')} />
                        </div>
                    )}
                </div>
            );
        }

        const NavBtn = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center p-2 rounded-xl transition w-16 ${active ? 'text-blue-600 bg-blue-50' : 'text-gray-400 hover:text-gray-600'}`}>
                {icon}
                <span className="text-[10px] font-bold mt-1">{label}</span>
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IP-55 Helper</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .animate-enter { animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // –ì–ª–æ–±–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ "–±—ñ–ª–æ–≥–æ –µ–∫—Ä–∞–Ω—É"
        window.onerror = function(msg, url, line, col, error) {
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –º–∏ –≤ Telegram (—â–æ–± –Ω–µ –ª—è–∫–∞—Ç–∏ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ, —è–∫—â–æ —Ç–∞–º –ø—Ä–∞—Ü—é—î)
            if (window.Telegram?.WebApp?.initData) {
                const root = document.getElementById('root');
                root.innerHTML = `
                    <div style="padding: 20px; color: red; font-family: sans-serif; text-align: center;">
                        <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞</h2>
                        <p style="font-size: 12px; background: #fee; padding: 10px; border-radius: 8px; word-break: break-all;">
                            ${msg}<br>Line: ${line}
                        </p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 8px;">–û–Ω–æ–≤–∏—Ç–∏</button>
                    </div>
                `;
            }
        };

        const { useState, useEffect } = React;
        const API = '/api';
        
        // --- Icons ---
        const Icons = {
            ArrowLeft: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
            Plus: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Trash: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Edit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
            Play: () => <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z" /></svg>,
            Clock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            UserPlus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>,
            Settings: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        };

        const QUEUE_STATUSES = {
            'waiting': { label: '–í —á–µ—Ä–∑—ñ', color: 'bg-white', icon: '‚è≥' },
            'preparing': { label: '–ì–æ—Ç—É—î—Ç—å—Å—è', color: 'bg-yellow-100', icon: 'üìù' },
            'defending': { label: '–ó–¥–∞—î', color: 'bg-green-100', icon: '‚ñ∂Ô∏è' },
            'completed': { label: '–ó–¥–∞–≤', color: 'bg-blue-100', icon: '‚úÖ' },
            'failed': { label: '–ù–µ –∑–¥–∞–≤', color: 'bg-red-100', icon: '‚ùå' },
            'skipped': { label: '–ü—Ä–æ–ø—É—Å—Ç–∏–≤', color: 'bg-gray-100', icon: '‚è≠Ô∏è' }
        };

        // --- COMPONENTS ---

        function SettingsModal({ isOpen, onClose, user, onSave }) {
            const [name, setName] = useState(user?.officialName || '');
            
            useEffect(() => {
                if(isOpen && user) setName(user.officialName || user.fullName || '');
            }, [isOpen, user]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-sm rounded-2xl p-5 animate-enter">
                        <h3 className="text-lg font-bold mb-2">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</h3>
                        <p className="text-sm text-gray-500 mb-4">–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —Å–ø—Ä–∞–≤–∂–Ω—î –ü—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ –Ü–º'—è –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ —á–µ—Ä–∑—ñ.</p>
                        
                        <div className="mb-4">
                            <label className="block text-sm font-bold text-gray-700 mb-1">–í–∞—à–µ –ü–Ü–ë</label>
                            <input 
                                type="text" 
                                className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-blue-500"
                                placeholder="–¢–∞—Ä–∞—Å –®–µ–≤—á–µ–Ω–∫–æ –ì—Ä–∏–≥–æ—Ä–æ–≤–∏—á"
                                value={name}
                                onChange={e => setName(e.target.value)}
                            />
                        </div>

                        <div className="flex gap-2">
                            <button onClick={() => onSave(name)} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold active:scale-95 transition">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                            <button onClick={onClose} className="px-4 bg-gray-100 rounded-xl font-bold active:scale-95 transition">–ó–∞–∫—Ä–∏—Ç–∏</button>
                        </div>
                    </div>
                </div>
            );
        }

        function SubjectsList({ user, isAdmin, onNavigate, onOpenSettings }) {
            const [subjects, setSubjects] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editSub, setEditSub] = useState(null); 
            const [form, setForm] = useState({ 
                name: '', 
                teacherLecture: '', 
                teacherPractice: '',
                hasQueue: true,
                hasTopics: true,
                hasHomework: true
            });

            useEffect(() => {
                fetch(`${API}/subjects`).then(r => r.json()).then(setSubjects).catch(err => console.error("Subjects fetch error:", err));
            }, []);

            const openModal = (sub = null) => {
                setEditSub(sub);
                if (sub) {
                    setForm({
                        name: sub.name,
                        teacherLecture: sub.teacherLecture || '',
                        teacherPractice: sub.teacherPractice || '',
                        hasQueue: sub.hasQueue !== undefined ? sub.hasQueue : true,
                        hasTopics: sub.hasTopics !== undefined ? sub.hasTopics : true,
                        hasHomework: sub.hasHomework !== undefined ? sub.hasHomework : true,
                    });
                } else {
                    setForm({ name: '', teacherLecture: '', teacherPractice: '', hasQueue: true, hasTopics: true, hasHomework: true });
                }
                setIsModalOpen(true);
            };

            const save = async () => {
                const url = editSub ? `${API}/subjects/${editSub._id}` : `${API}/subjects`;
                const method = editSub ? 'PUT' : 'POST';
                await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(form) });
                setIsModalOpen(false);
                fetch(`${API}/subjects`).then(r => r.json()).then(setSubjects);
            };
            
            const del = async (id, e) => {
                e.stopPropagation();
                if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç?')) {
                    await fetch(`${API}/subjects/${id}`, { method: 'DELETE' });
                    setSubjects(subjects.filter(s => s._id !== id));
                }
            };

            const Toggle = ({ label, checked, onChange }) => (
                <div className="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                    <span className="text-sm font-medium text-gray-700">{label}</span>
                    <label className="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" className="sr-only peer" checked={checked} onChange={e => onChange(e.target.checked)} />
                        <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            );

            return (
                <div className="p-4 animate-enter pb-24">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-gray-800">–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∏</h1>
                        <div className="flex gap-2">
                             <button onClick={onOpenSettings} className="p-2 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition"><Icons.Settings /></button>
                            {isAdmin && <button onClick={() => openModal()} className="p-2 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition"><Icons.Plus /></button>}
                        </div>
                    </div>

                    <div className="grid gap-3">
                        {subjects.map(sub => (
                            <div key={sub._id} onClick={() => onNavigate('details', sub)} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 active:scale-[0.98] transition-transform relative overflow-hidden">
                                <h3 className="font-bold text-lg text-gray-800 relative z-10">{sub.name}</h3>
                                <p className="text-sm text-gray-500 mt-1 relative z-10">{sub.teacherPractice || sub.teacherLecture || '–í–∏–∫–ª–∞–¥–∞—á –Ω–µ –≤–∫–∞–∑–∞–Ω–∏–π'}</p>
                                {isAdmin && (
                                    <div className="absolute bottom-4 right-4 z-20 flex gap-2">
                                        <button onClick={(e) => { e.stopPropagation(); openModal(sub); }} className="text-gray-400 hover:text-blue-500"><Icons.Edit /></button>
                                        <button onClick={(e) => del(sub._id, e)} className="text-gray-400 hover:text-red-500"><Icons.Trash /></button>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5">
                                <h3 className="font-bold mb-4">{editSub ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏' : '–ù–æ–≤–∏–π –ø—Ä–µ–¥–º–µ—Ç'}</h3>
                                <input placeholder="–ù–∞–∑–≤–∞" className="w-full p-2 bg-gray-50 rounded mb-2 border" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                                <input placeholder="–õ–µ–∫—Ç–æ—Ä" className="w-full p-2 bg-gray-50 rounded mb-2 border" value={form.teacherLecture} onChange={e => setForm({...form, teacherLecture: e.target.value})} />
                                <input placeholder="–ü—Ä–∞–∫—Ç–∏–∫" className="w-full p-2 bg-gray-50 rounded mb-2 border" value={form.teacherPractice} onChange={e => setForm({...form, teacherPractice: e.target.value})} />
                                
                                <div className="mt-4 mb-4 bg-gray-50 p-3 rounded-lg">
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-2">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h4>
                                    <Toggle label="–ß–µ—Ä–≥–∞" checked={form.hasQueue} onChange={v => setForm({...form, hasQueue: v})} />
                                    <Toggle label="–¢–µ–º–∏ —Ä–µ—Ñ–µ—Ä–∞—Ç—ñ–≤" checked={form.hasTopics} onChange={v => setForm({...form, hasTopics: v})} />
                                    <Toggle label="–î–æ–º–∞—à–Ω—î –∑–∞–≤–¥–∞–Ω–Ω—è" checked={form.hasHomework} onChange={v => setForm({...form, hasHomework: v})} />
                                </div>

                                <div className="flex gap-2 mt-4">
                                    <button onClick={save} className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 bg-gray-100 rounded-lg">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function SubjectDetails({ subject, user, isAdmin, onNavigate, onBack }) {
            if (!subject) return <div className="p-10 text-center"><button onClick={onBack} className="text-blue-500">–ù–∞–∑–∞–¥</button></div>;

            const { hasQueue = true, hasTopics = true, hasHomework = true } = subject;

            return (
                <div className="min-h-screen bg-white animate-enter">
                    <div className="p-4 border-b flex items-center gap-4 sticky top-0 bg-white z-20">
                        <button onClick={onBack} className="p-2 -ml-2 hover:bg-gray-100 rounded-full"><Icons.ArrowLeft /></button>
                        <h1 className="font-bold text-lg truncate">{subject.name}</h1>
                    </div>
                    
                    <div className="p-5 space-y-6">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                <span className="text-xs font-bold text-purple-400 uppercase tracking-wider">–õ–µ–∫—Ç–æ—Ä</span>
                                <p className="font-semibold text-gray-800 mt-1">{subject.teacherLecture || '-'}</p>
                            </div>
                            <div className="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                <span className="text-xs font-bold text-orange-400 uppercase tracking-wider">–ü—Ä–∞–∫—Ç–∏–∫</span>
                                <p className="font-semibold text-gray-800 mt-1">{subject.teacherPractice || '-'}</p>
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-gray-800 mb-3">–î—ñ—ó</h3>
                            <div className="grid gap-3">
                                {hasQueue && (
                                    <button onClick={() => onNavigate('queue', subject)} className="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between hover:bg-gray-100 transition active:scale-[0.99]">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">Q</div>
                                            <div className="text-left">
                                                <p className="font-bold text-gray-800">–ß–µ—Ä–≥–∞ –Ω–∞ –∑–¥–∞—á—É</p>
                                                <p className="text-xs text-gray-500">–ó–∞–ø–∏—Å –Ω–∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ñ</p>
                                            </div>
                                        </div>
                                        <Icons.Play />
                                    </button>
                                )}
                                {hasTopics && (
                                    <button onClick={() => onNavigate('topics', subject)} className="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between hover:bg-gray-100 transition active:scale-[0.99]">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center font-bold">T</div>
                                            <div className="text-left">
                                                <p className="font-bold text-gray-800">–¢–µ–º–∏ —Ä–µ—Ñ–µ—Ä–∞—Ç—ñ–≤</p>
                                                <p className="text-xs text-gray-500">–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —Ç–µ–º</p>
                                            </div>
                                        </div>
                                        <Icons.Play />
                                    </button>
                                )}
                                {hasHomework && (
                                    <button onClick={() => onNavigate('homework', subject)} className="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between hover:bg-gray-100 transition active:scale-[0.99]">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center font-bold">H</div>
                                            <div className="text-left">
                                                <p className="font-bold text-gray-800">–î–æ–º–∞—à–Ω—î –∑–∞–≤–¥–∞–Ω–Ω—è</p>
                                                <p className="text-xs text-gray-500">–ü–µ—Ä–µ–≥–ª—è–¥ —Ç–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è</p>
                                            </div>
                                        </div>
                                        <Icons.Play />
                                    </button>
                                )}
                                {!hasQueue && !hasTopics && !hasHomework && (
                                    <p className="text-center text-gray-400 py-4">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –¥—ñ–π –¥–ª—è —Ü—å–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Queue({ subject, user, isAdmin, onBack }) {
            const [queue, setQueue] = useState(null);
            const [labNum, setLabNum] = useState('');
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [isAddUserOpen, setIsAddUserOpen] = useState(false);
            const [allUsers, setAllUsers] = useState([]);
            const [searchUser, setSearchUser] = useState('');
            const [targetSlot, setTargetSlot] = useState(null);

            if (!subject) return <div className="p-10 text-center"><button onClick={onBack}>–ù–∞–∑–∞–¥</button></div>;

            const load = async () => {
                try {
                    let res = await fetch(`${API}/queues/subject/${subject._id}`);
                    let data = await res.json();
                    if (!data) {
                        await fetch(`${API}/queues`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ subjectId: subject._id }) });
                        res = await fetch(`${API}/queues/subject/${subject._id}`);
                        data = await res.json();
                    }
                    setQueue(data);
                } catch(e) { console.error(e); }
            };

            const fetchUsers = async () => {
                const res = await fetch(`${API}/users`);
                const data = await res.json();
                setAllUsers(data);
            };

            useEffect(() => { load(); const i = setInterval(load, 5000); return () => clearInterval(i); }, []);

            const join = async (pos, adminAddId = null) => {
                if(!labNum) return alert('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó!');
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ü–Ü–ë
                if (!adminAddId && !user.officialName) {
                    if (!confirm("–í–∏ –Ω–µ –≤–∫–∞–∑–∞–ª–∏ —Å–≤–æ—î –ü–Ü–ë –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ–º'—è –∑ Telegram?")) return;
                }

                const body = { 
                    queueId: queue._id, 
                    telegramId: user?.id, 
                    labNumber: parseInt(labNum), 
                    position: pos, 
                    isAdminAdd: !!adminAddId,
                    targetUserId: adminAddId
                };

                const res = await fetch(`${API}/queues/join`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if(!res.ok) {
                    const err = await res.json();
                    alert(err.detail);
                } else {
                    setLabNum(''); setSelectedSlot(null); setIsAddUserOpen(false); load();
                }
            };

            const kick = async (uid) => {
                await fetch(`${API}/queues/leave`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ queueId: queue._id, isAdminKick: true, targetUserId: uid })
                });
                load(); setSelectedSlot(null);
            };

            const setStatus = async (uid, st) => {
                await fetch(`${API}/queues/status`, {
                    method: 'PATCH', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ queueId: queue._id, userId: uid, status: st, adminId: user.id })
                });
                load(); setSelectedSlot(null);
            };

            const toggleQueue = async () => {
                await fetch(`${API}/queues/toggle`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ queueId: queue._id, adminId: user.id }) });
                load();
            };

            const toggleRule = async () => {
                await fetch(`${API}/queues/config`, { 
                    method: 'PATCH', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ queueId: queue._id, adminId: user.id, minMaxRule: !queue.config?.minMaxRule }) 
                });
                load();
            }

            if(!queue) return <div className="p-10 text-center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>;

            const filteredUsers = allUsers.filter(u => (u.officialName || u.fullName)?.toLowerCase().includes(searchUser.toLowerCase()));

            return (
                <div className="min-h-screen bg-gray-50 pb-20 animate-enter">
                    <div className="bg-white p-4 sticky top-0 z-10 shadow-sm flex justify-between items-center">
                        <div className="flex gap-2 items-center">
                            <button onClick={onBack}><Icons.ArrowLeft /></button>
                            <h2 className="font-bold">{subject.name}</h2>
                        </div>
                        {isAdmin && (
                            <div className="flex gap-2">
                                <button onClick={toggleRule} className={`px-2 py-1 text-xs font-bold rounded border ${queue.config?.minMaxRule ? 'bg-blue-100 text-blue-600' : 'bg-gray-100'}`}>–ú—ñ–Ω+2</button>
                                <button onClick={toggleQueue} className={`px-2 py-1 text-xs font-bold rounded border ${queue.isActive ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{queue.isActive ? 'ON' : 'OFF'}</button>
                            </div>
                        )}
                    </div>
                    
                    <div className="p-2 grid grid-cols-3 gap-2">
                        {Array.from({length: 30}, (_, i) => i+1).map(i => {
                            const entry = queue.entries.find(e => e.position === i);
                            const statusInfo = entry ? QUEUE_STATUSES[entry.status] : null;
                            const cardColor = statusInfo ? statusInfo.color : 'bg-white';
                            
                            return (
                                <div key={i} onClick={() => setSelectedSlot({ i, entry })} 
                                    className={`aspect-[4/5] rounded-xl border flex flex-col p-2 relative cursor-pointer active:scale-95 transition shadow-sm ${cardColor} ${!entry ? 'border-dashed border-gray-300 opacity-80' : 'border-gray-200'}`}>
                                    
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="text-xs font-bold text-gray-400">#{i}</span>
                                        {entry && <div className="text-sm">{statusInfo?.icon}</div>}
                                    </div>

                                    {entry ? (
                                        <div className="flex flex-col items-center flex-1 w-full overflow-hidden">
                                            {/* –ê–≤–∞—Ç–∞—Ä */}
                                            <div className="w-10 h-10 rounded-full bg-gray-200 mb-2 overflow-hidden border">
                                                {entry.user?.avatarUrl ? (
                                                    <img src={entry.user.avatarUrl} className="w-full h-full object-cover" alt="ava" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-gray-400 text-xs font-bold bg-gray-100">
                                                        {(entry.user?.officialName || entry.user?.fullName || '?')[0]}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* –ü–Ü–ë - –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç officialName */}
                                            <div className="text-[10px] font-bold text-center leading-tight line-clamp-2 w-full">
                                                {entry.user?.officialName || entry.user?.fullName || '–ì—ñ—Å—Ç—å'}
                                            </div>
                                            
                                            {/* –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ */}
                                            <div className="mt-auto pt-1">
                                                 <span className="text-[9px] font-bold bg-gray-100 px-1.5 py-0.5 rounded text-gray-600">
                                                    –õ–± {entry.labNumber}
                                                 </span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex-1 flex items-center justify-center">
                                            <span className="text-gray-300 text-2xl">+</span>
                                        </div>
                                    )}
                                </div>
                            )
                        })}
                    </div>

                    {/* –ú–æ–¥–∞–ª–∫–∞ —Å–ª–æ—Ç–∞ */}
                    {selectedSlot && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-6" onClick={() => setSelectedSlot(null)}>
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">–°–ª–æ—Ç #{selectedSlot.i}</h3>
                                {selectedSlot.entry ? (
                                    <div className="text-center mb-6">
                                        <div className="w-20 h-20 rounded-full bg-gray-200 mx-auto mb-3 overflow-hidden border-2 border-white shadow">
                                             {selectedSlot.entry.user?.avatarUrl ? <img src={selectedSlot.entry.user.avatarUrl} className="w-full h-full object-cover" alt="avatar" /> : null}
                                        </div>
                                        <p className="text-xl font-bold">{selectedSlot.entry.user?.officialName || selectedSlot.entry.user?.fullName}</p>
                                        <p className="text-sm text-gray-500 mb-2">@{selectedSlot.entry.user?.username || 'no_username'}</p>
                                        <div className="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ ‚Ññ{selectedSlot.entry.labNumber}</div>
                                        
                                        {isAdmin && (
                                            <div className="mt-6 space-y-3 text-left">
                                                <div className="grid grid-cols-2 gap-2">
                                                    {Object.entries(QUEUE_STATUSES).map(([key, val]) => (
                                                         <button key={key} onClick={() => setStatus(selectedSlot.entry.userId, key)} className={`p-2 rounded-lg text-sm font-bold border ${val.color} opacity-80 hover:opacity-100`}>{val.icon} {val.label}</button>
                                                    ))}
                                                </div>
                                                <button onClick={() => kick(selectedSlot.entry.userId)} className="w-full bg-red-100 text-red-600 py-2 rounded-lg font-bold">–í–∏–¥–∞–ª–∏—Ç–∏ –∑ —á–µ—Ä–≥–∏</button>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <>
                                        {(queue.isActive || isAdmin) ? (
                                            <>
                                                <input type="number" placeholder="–ù–æ–º–µ—Ä –ª–∞–±–∏" className="w-full p-3 bg-gray-100 rounded-xl mb-4 text-center font-bold text-lg" value={labNum} onChange={e => setLabNum(e.target.value)} />
                                                <button onClick={() => join(selectedSlot.i)} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-2">–ó–∞–ø–∏—Å–∞—Ç–∏—Å—è</button>
                                                {isAdmin && (
                                                    <button onClick={() => { setIsAddUserOpen(true); setTargetSlot(selectedSlot.i); fetchUsers(); setSelectedSlot(null); }} className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                                        <Icons.UserPlus /> –î–æ–¥–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
                                                    </button>
                                                )}
                                            </>
                                        ) : <p className="text-red-500 font-bold text-center">–ß–µ—Ä–≥–∞ –∑–∞–∫—Ä–∏—Ç–∞</p>}
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {isAddUserOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5 h-[80vh] flex flex-col">
                                <h3 className="font-bold mb-4">–û–±–µ—Ä—ñ—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ (–°–ª–æ—Ç #{targetSlot})</h3>
                                <input placeholder="–ü–æ—à—É–∫..." className="p-2 border rounded-lg mb-4" value={searchUser} onChange={e => setSearchUser(e.target.value)} />
                                <div className="overflow-y-auto flex-1 space-y-2">
                                    {filteredUsers.map(u => (
                                        <div key={u._id} onClick={() => join(targetSlot, u._id)} className="p-3 bg-gray-50 rounded-lg font-bold active:bg-blue-100 border flex justify-between">
                                            <span>{u.officialName || u.fullName}</span>
                                            {u.officialName && <span className="text-xs bg-green-100 text-green-700 px-1 rounded">–ü–Ü–ë</span>}
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setIsAddUserOpen(false)} className="mt-4 p-3 bg-gray-100 rounded-xl font-bold">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Topics({ subject, user, isAdmin, onBack }) {
            const [topics, setTopics] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editTopic, setEditTopic] = useState(null);
            const [title, setTitle] = useState('');

            if (!subject) return <div className="p-10 text-center"><button onClick={onBack}>–ù–∞–∑–∞–¥</button></div>;

            const load = () => fetch(`${API}/topics/${subject._id}`).then(r => r.json()).then(setTopics);
            useEffect(() => { load(); }, []);

            const save = async () => {
                const url = editTopic ? `${API}/topics/${editTopic._id}` : `${API}/topics`;
                const method = editTopic ? 'PUT' : 'POST';
                await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ subjectId: subject._id, adminId: user.id, title }) });
                setIsModalOpen(false); load();
            };

            const del = async (id) => {
                if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–º—É?')) {
                    await fetch(`${API}/topics/${id}?adminId=${user.id}`, { method: 'DELETE' });
                    load();
                }
            };

            const toggle = async (t) => {
                if (!user || !user._mongoId) return alert("–ó–∞—á–µ–∫–∞–π—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é...");
                await fetch(`${API}/topics/toggle`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ topicId: t._id, telegramId: user.id }) });
                load();
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4 animate-enter">
                    <div className="flex gap-3 mb-4 items-center justify-between">
                        <div className="flex gap-2 items-center">
                            <button onClick={onBack}><Icons.ArrowLeft /></button>
                            <h1 className="font-bold text-xl">–¢–µ–º–∏</h1>
                        </div>
                        {isAdmin && <button onClick={() => { setEditTopic(null); setTitle(''); setIsModalOpen(true); }} className="bg-blue-600 text-white p-2 rounded-lg"><Icons.Plus /></button>}
                    </div>
                    
                    <div className="space-y-3">
                        {topics.map(t => {
                            const myUser = user && user._mongoId && t.users?.some(u => u.userId === String(user._mongoId));
                            
                            return (
                                <div key={t._id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm relative">
                                    <div className="pr-8">
                                        <p className="font-medium text-gray-800 text-lg">{t.title}</p>
                                        {t.users?.length > 0 && (
                                            <div className="mt-2 flex flex-wrap gap-1">
                                                {t.users.map((u, idx) => (
                                                    <span key={idx} className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">{u.userName}</span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    
                                    <button onClick={() => toggle(t)} className={`mt-3 w-full py-2 rounded-lg font-bold text-sm ${myUser ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`}>
                                        {myUser ? '–ó–≤—ñ–ª—å–Ω–∏—Ç–∏ —Ç–µ–º—É' : '–ó–∞–π–Ω—è—Ç–∏ —Ç–µ–º—É'}
                                    </button>

                                    {isAdmin && (
                                        <div className="absolute top-2 right-2 flex gap-1">
                                            <button onClick={() => { setEditTopic(t); setTitle(t.title); setIsModalOpen(true); }} className="text-gray-400 p-1"><Icons.Edit /></button>
                                            <button onClick={() => del(t._id)} className="text-gray-400 p-1"><Icons.Trash /></button>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5">
                                <h3 className="font-bold mb-2">{editTopic ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏' : '–ù–æ–≤–∞ —Ç–µ–º–∞'}</h3>
                                <textarea className="w-full p-2 border rounded-lg mb-4" rows="3" value={title} onChange={e => setTitle(e.target.value)}></textarea>
                                <div className="flex gap-2">
                                    <button onClick={save} className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 bg-gray-100 rounded-lg">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        function Homework({ subject, user, isAdmin, onBack }) {
            const [hw, setHw] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editHw, setEditHw] = useState(null);
            const [form, setForm] = useState({ text: '', deadline: '' });
            
            if (!subject) return <div className="p-10 text-center"><button onClick={onBack}>–ù–∞–∑–∞–¥</button></div>;

            const load = () => fetch(`${API}/homework/${subject._id}`).then(r => r.json()).then(setHw);
            useEffect(() => { load(); }, []);

            const save = async () => {
                const url = editHw ? `${API}/homework/${editHw._id}` : `${API}/homework`;
                const method = editHw ? 'PUT' : 'POST';
                const body = { ...form, subjectId: subject._id, adminId: user.id, authorId: user.id };
                await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                setIsModalOpen(false); load();
            };

            const del = async (id) => {
                if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) {
                    await fetch(`${API}/homework/${id}?adminId=${user.id}`, { method: 'DELETE' });
                    load();
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4 animate-enter pb-24">
                     <div className="flex gap-3 mb-4 items-center justify-between">
                        <div className="flex gap-2 items-center">
                            <button onClick={onBack}><Icons.ArrowLeft /></button>
                            <h1 className="font-bold text-xl">–î–æ–º–∞—à–∫–∞</h1>
                        </div>
                        <button onClick={() => { setEditHw(null); setForm({text:'', deadline:''}); setIsModalOpen(true); }} className="bg-black text-white px-3 py-1 rounded-lg text-sm font-bold">+ –î–æ–¥–∞—Ç–∏</button>
                    </div>

                    <div className="space-y-3">
                        {hw.map(h => (
                            <div key={h._id} className="bg-white p-4 rounded-xl border border-gray-200 relative">
                                <p className="text-gray-800 whitespace-pre-wrap">{h.text}</p>
                                <div className="flex justify-between items-center mt-3 pt-3 border-t border-dashed">
                                    <span className="text-xs font-bold bg-red-50 text-red-500 px-2 py-1 rounded">–î–µ–¥–ª–∞–π–Ω: {h.deadline || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</span>
                                    {isAdmin && (
                                        <div className="flex gap-2">
                                             <button onClick={() => { setEditHw(h); setForm({text: h.text, deadline: h.deadline}); setIsModalOpen(true); }} className="text-blue-400 text-xs font-bold">–†–µ–¥.</button>
                                             <button onClick={() => del(h._id)} className="text-red-400 text-xs font-bold">–í–∏–¥.</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5">
                                <h3 className="font-bold mb-2">{editHw ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏' : '–ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è'}</h3>
                                <textarea className="w-full p-2 border rounded-lg mb-2 text-sm" rows="4" placeholder="–©–æ –∑–∞–¥–∞–ª–∏?" value={form.text} onChange={e => setForm({...form, text: e.target.value})}></textarea>
                                <input type="date" className="w-full p-2 border rounded-lg text-sm mb-4" value={form.deadline} onChange={e => setForm({...form, deadline: e.target.value})} />
                                <div className="flex gap-2">
                                    <button onClick={save} className="flex-1 bg-black text-white py-2 rounded-lg font-bold">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 bg-gray-100 rounded-lg">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )
        }

        function Schedule({ onNavigate }) {
            const [schedule, setSchedule] = useState(null);
            const [week, setWeek] = useState(1);
            const [error, setError] = useState(null);

            useEffect(() => { 
                fetch(`${API}/schedule`)
                    .then(r => r.json())
                    .then(data => {
                        if(data) setSchedule(data);
                        else setError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
                    })
                    .catch(() => setError('–ü–æ–º–∏–ª–∫–∞')); 
            }, []);

            if (error) return <div className="p-10 text-center text-red-500 font-bold">{error}</div>;
            if (!schedule) return <div className="p-10 text-center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É...</div>;

            const weekKey = week === 1 ? 'scheduleFirstWeek' : 'scheduleSecondWeek';
            
            // –ú–∞—Å–∏–≤ –¥–Ω—ñ–≤ –¥–ª—è —ñ—Ç–µ—Ä–∞—Ü—ñ—ó (–ø–æ—Ä—è–¥–æ–∫ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è)
            const daysOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // –ù–∞–∑–≤–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
            const dayHeaders = { 
                Monday: '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', Tuesday: '–í—ñ–≤—Ç–æ—Ä–æ–∫', Wednesday: '–°–µ—Ä–µ–¥–∞', 
                Thursday: '–ß–µ—Ç–≤–µ—Ä', Friday: "–ü'—è—Ç–Ω–∏—Ü—è", Saturday: "–°—É–±–æ—Ç–∞" 
            };
            
            // –ö–ª—é—á—ñ, —è–∫—ñ –ø–æ–≤–µ—Ä—Ç–∞—î API (Cyrillic)
            const apiDayKeys = { 
                Monday: '–ü–Ω', Tuesday: '–í–≤', Wednesday: '–°—Ä', 
                Thursday: '–ß—Ç', Friday: '–ü—Ç', Saturday: '–°–±' 
            };

            return (
                <div className="p-4 pb-24 animate-enter">
                    <div className="flex bg-gray-200 p-1 rounded-xl mb-4">
                        <button onClick={() => setWeek(1)} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${week===1 ? 'bg-white shadow' : 'text-gray-500'}`}>1 –¢–∏–∂–¥–µ–Ω—å</button>
                        <button onClick={() => setWeek(2)} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${week===2 ? 'bg-white shadow' : 'text-gray-500'}`}>2 –¢–∏–∂–¥–µ–Ω—å</button>
                    </div>

                    <div className="space-y-6">
                        {daysOrder.map(dayCode => {
                            // –®—É–∫–∞—î–º–æ –¥–µ–Ω—å –∑–∞ –∫–∏—Ä–∏–ª–∏—á–Ω–∏–º –∫–ª—é—á–µ–º, —è–∫–∏–π –¥–∞—î API
                            const dayData = schedule[weekKey].find(d => d.day === apiDayKeys[dayCode]);
                            
                            if (!dayData?.pairs?.length) return null;
                            
                            return (
                                <div key={dayCode}>
                                    <h3 className="text-gray-400 font-bold uppercase text-xs mb-2 pl-1">{dayHeaders[dayCode]}</h3>
                                    <div className="space-y-2">
                                        {dayData.pairs.map((pair, idx) => {
                                            const isLec = pair.type.includes('–õ–µ–∫');
                                            const isLab = pair.type.includes('–õ–∞–±');
                                            const color = isLec ? 'border-purple-500' : isLab ? 'border-blue-500' : 'border-orange-500';
                                            const bg = isLec ? 'bg-purple-50 text-purple-700' : isLab ? 'bg-blue-50 text-blue-700' : 'bg-orange-50 text-orange-700';
                                            
                                            return (
                                                <div key={idx} onClick={() => onNavigate('search_subject', pair.name)} className={`bg-white p-3 rounded-xl border-l-4 shadow-sm flex gap-3 ${color}`}>
                                                    <div className="font-bold text-gray-900 w-12 text-sm pt-1">{pair.time.substring(0, 5)}</div>
                                                    <div>
                                                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded uppercase ${bg}`}>{pair.type}</span>
                                                        <h4 className="font-bold text-gray-800 leading-tight my-1">{pair.name}</h4>
                                                        <p className="text-xs text-gray-500">{pair.teacherName}</p>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // --- ROOT APP ---
        function App() {
            const [history, setHistory] = useState([{ view: 'home', data: null }]);
            const [user, setUser] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            
            // --- –ü–û–ö–†–ê–©–ï–ù–û: –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å—Ç–∞–Ω "isTelegram" –æ–¥—Ä–∞–∑—É ---
            // –¶–µ –¥–æ–∑–≤–æ–ª—è—î —É–Ω–∏–∫–Ω—É—Ç–∏ "–º–∏–≥–æ—Ç—ñ–Ω–Ω—è" –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —ñ –±—ñ–ª–æ–≥–æ –µ–∫—Ä–∞–Ω—É
            const [isTelegram, setIsTelegram] = useState(() => !!window.Telegram?.WebApp?.initData);
            
            const ADMIN_IDS = [1876094081, 1117478810]; 

            useEffect(() => {
                const tg = window.Telegram?.WebApp;
                
                if (tg && tg.initData) {
                    setIsTelegram(true);
                    tg.ready(); 
                    tg.expand();
                    
                    const u = tg.initDataUnsafe?.user;
                    if(u) {
                        fetch(`${API}/users/update`, { 
                            method: 'POST', 
                            headers: {'Content-Type': 'application/json'}, 
                            body: JSON.stringify({ 
                                telegramId: u.id, 
                                fullName: `${u.first_name} ${u.last_name||''}`.trim(), 
                                username: u.username,
                                avatarUrl: u.photo_url 
                            }) 
                        });
                        
                        fetch(`${API}/users`).then(r => r.json()).then(users => {
                            const found = users.find(x => x.telegramId === u.id);
                            if(found) setUser({ ...u, ...found, _mongoId: found._id });
                            else setUser({ ...u, _mongoId: null }); 
                        });
                    }
                } else {
                    // –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏–ª–∏ –Ω–µ –≤ Telegram
                    setIsTelegram(false);
                }
            }, []);

            // --- –ï–ö–†–ê–ù –ë–õ–û–ö–£–í–ê–ù–ù–Ø (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ç–æ—á–Ω–æ –Ω–µ Telegram) ---
            if (!isTelegram) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center bg-gray-50">
                        <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mb-6 text-4xl">ü§ñ</div>
                        <h1 className="text-2xl font-bold text-gray-900 mb-2">–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ</h1>
                        <p className="text-gray-500 mb-6">–¶–µ–π –¥–æ–¥–∞—Ç–æ–∫ –ø—Ä–∞—Ü—é—î –≤–∏–∫–ª—é—á–Ω–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Telegram.</p>
                        <p className="text-sm text-gray-400">–ë—É–¥—å –ª–∞—Å–∫–∞, –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –±–æ—Ç–∞ —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é.</p>
                    </div>
                );
            }

            const active = history[history.length - 1];

            const navigate = (view, data = null) => {
                if(view === 'search_subject') {
                    fetch(`${API}/subjects`).then(r => r.json()).then(subs => {
                        const found = subs.find(s => s.name.toLowerCase().includes(data.toLowerCase()) || data.toLowerCase().includes(s.name.toLowerCase()));
                        if(found) setHistory(prev => [...prev, { view: 'details', data: found }]);
                        else alert('–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°—Ç–≤–æ—Ä—ñ—Ç—å –π–æ–≥–æ —Å–ø–æ—á–∞—Ç–∫—É –≤ —Ä–æ–∑–¥—ñ–ª—ñ "–ü—Ä–µ–¥–º–µ—Ç–∏".');
                    });
                    return;
                }
                setHistory(prev => [...prev, { view, data }]);
            };

            const back = () => { if (history.length > 1) { setHistory(prev => prev.slice(0, -1)); } };
            const goToTab = (view) => { setHistory([{ view, data: null }]); }

            useEffect(() => {
                const tg = window.Telegram?.WebApp;
                if (!tg) return;
                if (history.length > 1) { tg.BackButton.show(); tg.BackButton.onClick(back); } else { tg.BackButton.hide(); tg.BackButton.offClick(back); }
                return () => tg.BackButton.offClick(back);
            }, [history]);

            const saveSettings = async (officialName) => {
                if(!user) return;
                await fetch(`${API}/users/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ telegramId: user.id, username: user.username, officialName })
                });
                setUser({...user, officialName});
                setIsSettingsOpen(false);
            };

            const isAdmin = user && ADMIN_IDS.includes(user.id);

            const render = () => {
                switch(active.view) {
                    case 'home': return <SubjectsList user={user} isAdmin={isAdmin} onNavigate={navigate} onOpenSettings={() => setIsSettingsOpen(true)} />;
                    case 'details': return <SubjectDetails subject={active.data} user={user} isAdmin={isAdmin} onNavigate={navigate} onBack={back} />;
                    case 'queue': return <Queue subject={active.data} user={user} isAdmin={isAdmin} onBack={back} />;
                    case 'topics': return <Topics subject={active.data} user={user} isAdmin={isAdmin} onBack={back} />;
                    case 'homework': return <Homework subject={active.data} user={user} isAdmin={isAdmin} onBack={back} />;
                    case 'schedule': return <Schedule onNavigate={navigate} />;
                    default: return <SubjectsList />;
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen font-sans text-gray-900 pb-20">
                    {render()}
                    
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} user={user} onSave={saveSettings} />

                    {history.length === 1 && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 pb-6 z-50">
                            <button onClick={() => goToTab('home')} className={`flex flex-col items-center p-2 rounded-xl w-20 transition ${active.view==='home'?'text-blue-600 bg-blue-50':'text-gray-400'}`}>
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                                <span className="text-[10px] font-bold mt-1">–ü—Ä–µ–¥–º–µ—Ç–∏</span>
                            </button>
                            <button onClick={() => goToTab('schedule')} className={`flex flex-col items-center p-2 rounded-xl w-20 transition ${active.view==='schedule'?'text-blue-600 bg-blue-50':'text-gray-400'}`}>
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                <span className="text-[10px] font-bold mt-1">–†–æ–∑–∫–ª–∞–¥</span>
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
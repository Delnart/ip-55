<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Університетський помічник</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .animate-enter { animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Стиль для перемикача */
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API = '/api';
        
        // --- Icons ---
        const Icons = {
            ArrowLeft: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
            Plus: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Trash: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Edit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
            Play: () => <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z" /></svg>,
            Clock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            UserPlus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
        };

        // --- COMPONENTS ---

        function SubjectsList({ user, isAdmin, onNavigate }) {
            const [subjects, setSubjects] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editSub, setEditSub] = useState(null); 
            // Додані поля hasQueue, hasTopics, hasHomework
            const [form, setForm] = useState({ 
                name: '', 
                teacherLecture: '', 
                teacherPractice: '',
                hasQueue: true,
                hasTopics: true,
                hasHomework: true
            });

            useEffect(() => {
                fetch(`${API}/subjects`).then(r => r.json()).then(setSubjects);
            }, []);

            const openModal = (sub = null) => {
                setEditSub(sub);
                if (sub) {
                    setForm({
                        name: sub.name,
                        teacherLecture: sub.teacherLecture || '',
                        teacherPractice: sub.teacherPractice || '',
                        // Якщо поле відсутнє (старий предмет), вважаємо його true
                        hasQueue: sub.hasQueue !== undefined ? sub.hasQueue : true,
                        hasTopics: sub.hasTopics !== undefined ? sub.hasTopics : true,
                        hasHomework: sub.hasHomework !== undefined ? sub.hasHomework : true,
                    });
                } else {
                    setForm({ name: '', teacherLecture: '', teacherPractice: '', hasQueue: true, hasTopics: true, hasHomework: true });
                }
                setIsModalOpen(true);
            };

            const save = async () => {
                const url = editSub ? `${API}/subjects/${editSub._id}` : `${API}/subjects`;
                const method = editSub ? 'PUT' : 'POST';
                await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(form) });
                setIsModalOpen(false);
                fetch(`${API}/subjects`).then(r => r.json()).then(setSubjects);
            };
            
            const del = async (id, e) => {
                e.stopPropagation();
                if(confirm('Видалити предмет?')) {
                    await fetch(`${API}/subjects/${id}`, { method: 'DELETE' });
                    setSubjects(subjects.filter(s => s._id !== id));
                }
            };

            // Компонент перемикача
            const Toggle = ({ label, checked, onChange }) => (
                <div className="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                    <span className="text-sm font-medium text-gray-700">{label}</span>
                    <label className="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" className="sr-only peer" checked={checked} onChange={e => onChange(e.target.checked)} />
                        <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            );

            return (
                <div className="p-4 animate-enter pb-24">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-gray-800">Дисципліни</h1>
                        {isAdmin && <button onClick={() => openModal()} className="p-2 bg-blue-100 text-blue-600 rounded-full"><Icons.Plus /></button>}
                    </div>

                    <div className="grid gap-3">
                        {subjects.map(sub => (
                            <div key={sub._id} onClick={() => onNavigate('details', sub)} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 active:scale-[0.98] transition-transform relative overflow-hidden">
                                <h3 className="font-bold text-lg text-gray-800 relative z-10">{sub.name}</h3>
                                <p className="text-sm text-gray-500 mt-1 relative z-10">{sub.teacherPractice || sub.teacherLecture || 'Викладач не вказаний'}</p>
                                {isAdmin && (
                                    <div className="absolute bottom-4 right-4 z-20 flex gap-2">
                                        <button onClick={(e) => { e.stopPropagation(); openModal(sub); }} className="text-gray-400 hover:text-blue-500"><Icons.Edit /></button>
                                        <button onClick={(e) => del(sub._id, e)} className="text-gray-400 hover:text-red-500"><Icons.Trash /></button>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5">
                                <h3 className="font-bold mb-4">{editSub ? 'Редагувати' : 'Новий предмет'}</h3>
                                <input placeholder="Назва" className="w-full p-2 bg-gray-50 rounded mb-2 border" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                                <input placeholder="Лектор" className="w-full p-2 bg-gray-50 rounded mb-2 border" value={form.teacherLecture} onChange={e => setForm({...form, teacherLecture: e.target.value})} />
                                <input placeholder="Практик" className="w-full p-2 bg-gray-50 rounded mb-2 border" value={form.teacherPractice} onChange={e => setForm({...form, teacherPractice: e.target.value})} />
                                
                                <div className="mt-4 mb-4 bg-gray-50 p-3 rounded-lg">
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-2">Налаштування</h4>
                                    <Toggle label="Черга" checked={form.hasQueue} onChange={v => setForm({...form, hasQueue: v})} />
                                    <Toggle label="Теми рефератів" checked={form.hasTopics} onChange={v => setForm({...form, hasTopics: v})} />
                                    <Toggle label="Домашнє завдання" checked={form.hasHomework} onChange={v => setForm({...form, hasHomework: v})} />
                                </div>

                                <div className="flex gap-2 mt-4">
                                    <button onClick={save} className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">Зберегти</button>
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 bg-gray-100 rounded-lg">Скасувати</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function SubjectDetails({ subject, user, isAdmin, onNavigate, onBack }) {
            if (!subject) return <div className="p-10 text-center"><button onClick={onBack} className="text-blue-500">Назад</button></div>;

            // Деструктуризація з дефолтними значеннями (для сумісності зі старими даними)
            const { hasQueue = true, hasTopics = true, hasHomework = true } = subject;

            return (
                <div className="min-h-screen bg-white animate-enter">
                    <div className="p-4 border-b flex items-center gap-4 sticky top-0 bg-white z-20">
                        <button onClick={onBack} className="p-2 -ml-2 hover:bg-gray-100 rounded-full"><Icons.ArrowLeft /></button>
                        <h1 className="font-bold text-lg truncate">{subject.name}</h1>
                    </div>
                    
                    <div className="p-5 space-y-6">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                <span className="text-xs font-bold text-purple-400 uppercase tracking-wider">Лектор</span>
                                <p className="font-semibold text-gray-800 mt-1">{subject.teacherLecture || '-'}</p>
                            </div>
                            <div className="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                <span className="text-xs font-bold text-orange-400 uppercase tracking-wider">Практик</span>
                                <p className="font-semibold text-gray-800 mt-1">{subject.teacherPractice || '-'}</p>
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-gray-800 mb-3">Дії</h3>
                            <div className="grid gap-3">
                                {hasQueue && (
                                    <button onClick={() => onNavigate('queue', subject)} className="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between hover:bg-gray-100 transition active:scale-[0.99]">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">Q</div>
                                            <div className="text-left">
                                                <p className="font-bold text-gray-800">Черга на здачу</p>
                                                <p className="text-xs text-gray-500">Запис на лабораторні</p>
                                            </div>
                                        </div>
                                        <Icons.Play />
                                    </button>
                                )}
                                {hasTopics && (
                                    <button onClick={() => onNavigate('topics', subject)} className="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between hover:bg-gray-100 transition active:scale-[0.99]">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center font-bold">T</div>
                                            <div className="text-left">
                                                <p className="font-bold text-gray-800">Теми рефератів</p>
                                                <p className="text-xs text-gray-500">Бронювання тем</p>
                                            </div>
                                        </div>
                                        <Icons.Play />
                                    </button>
                                )}
                                {hasHomework && (
                                    <button onClick={() => onNavigate('homework', subject)} className="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between hover:bg-gray-100 transition active:scale-[0.99]">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center font-bold">H</div>
                                            <div className="text-left">
                                                <p className="font-bold text-gray-800">Домашнє завдання</p>
                                                <p className="text-xs text-gray-500">Перегляд та додавання</p>
                                            </div>
                                        </div>
                                        <Icons.Play />
                                    </button>
                                )}
                                {!hasQueue && !hasTopics && !hasHomework && (
                                    <p className="text-center text-gray-400 py-4">Немає доступних дій для цього предмета.</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Queue({ subject, user, isAdmin, onBack }) {
            const [queue, setQueue] = useState(null);
            const [labNum, setLabNum] = useState('');
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [isAddUserOpen, setIsAddUserOpen] = useState(false);
            const [allUsers, setAllUsers] = useState([]);
            const [searchUser, setSearchUser] = useState('');
            const [targetSlot, setTargetSlot] = useState(null);

            if (!subject) return <div className="p-10 text-center"><button onClick={onBack}>Назад</button></div>;

            const load = async () => {
                try {
                    let res = await fetch(`${API}/queues/subject/${subject._id}`);
                    let data = await res.json();
                    if (!data) {
                        await fetch(`${API}/queues`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ subjectId: subject._id }) });
                        res = await fetch(`${API}/queues/subject/${subject._id}`);
                        data = await res.json();
                    }
                    setQueue(data);
                } catch(e) { console.error(e); }
            };

            const fetchUsers = async () => {
                const res = await fetch(`${API}/users`);
                const data = await res.json();
                setAllUsers(data);
            };

            useEffect(() => { load(); const i = setInterval(load, 5000); return () => clearInterval(i); }, []);

            const join = async (pos, adminAddId = null) => {
                if(!labNum) return alert('Введіть номер лабораторної!');
                
                const body = { 
                    queueId: queue._id, 
                    telegramId: user?.id, 
                    labNumber: parseInt(labNum), 
                    position: pos,
                    isAdminAdd: !!adminAddId,
                    targetUserId: adminAddId
                };

                const res = await fetch(`${API}/queues/join`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if(!res.ok) {
                    const err = await res.json();
                    alert(err.detail);
                } else {
                    setLabNum(''); setSelectedSlot(null); setIsAddUserOpen(false); load();
                }
            };

            const kick = async (uid) => {
                await fetch(`${API}/queues/leave`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ queueId: queue._id, isAdminKick: true, targetUserId: uid })
                });
                load(); setSelectedSlot(null);
            };

            const setStatus = async (uid, st) => {
                await fetch(`${API}/queues/status`, {
                    method: 'PATCH', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ queueId: queue._id, userId: uid, status: st, adminId: user.id })
                });
                load(); setSelectedSlot(null);
            };

            const toggleQueue = async () => {
                await fetch(`${API}/queues/toggle`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ queueId: queue._id, adminId: user.id }) });
                load();
            };

            const toggleRule = async () => {
                await fetch(`${API}/queues/config`, { 
                    method: 'PATCH', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ queueId: queue._id, adminId: user.id, minMaxRule: !queue.config?.minMaxRule }) 
                });
                load();
            }

            if(!queue) return <div className="p-10 text-center">Завантаження...</div>;
            const STATUS_COLORS = { preparing: 'bg-yellow-50 border-yellow-300', defending: 'bg-green-50 border-green-300', completed: 'bg-blue-50 border-blue-300', waiting: 'bg-white border-gray-200' };

            const filteredUsers = allUsers.filter(u => u.fullName?.toLowerCase().includes(searchUser.toLowerCase()));

            return (
                <div className="min-h-screen bg-gray-50 pb-20 animate-enter">
                    <div className="bg-white p-4 sticky top-0 z-10 shadow-sm flex justify-between items-center">
                        <div className="flex gap-2 items-center">
                            <button onClick={onBack}><Icons.ArrowLeft /></button>
                            <h2 className="font-bold">{subject.name}</h2>
                        </div>
                        {isAdmin && (
                            <div className="flex gap-2">
                                <button onClick={toggleRule} className={`px-2 py-1 text-xs font-bold rounded border ${queue.config?.minMaxRule ? 'bg-blue-100 text-blue-600' : 'bg-gray-100'}`}>Мін+2</button>
                                <button onClick={toggleQueue} className={`px-2 py-1 text-xs font-bold rounded border ${queue.isActive ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{queue.isActive ? 'ON' : 'OFF'}</button>
                            </div>
                        )}
                    </div>
                    
                    <div className="p-2 grid grid-cols-4 gap-2">
                        {Array.from({length: 31}, (_, i) => i+1).map(i => {
                            const entry = queue.entries.find(e => e.position === i);
                            const style = entry ? STATUS_COLORS[entry.status] || 'bg-white' : 'bg-white border-dashed border-gray-300 opacity-70';
                            
                            return (
                                <div key={i} onClick={() => setSelectedSlot({ i, entry })} 
                                    className={`aspect-square rounded-xl border-2 flex flex-col items-center justify-center p-1 relative cursor-pointer active:scale-95 transition ${style}`}>
                                    <span className="absolute top-0.5 left-1 text-[8px] font-bold text-gray-400">{i}</span>
                                    {entry ? (
                                        <>
                                            <div className="text-[9px] font-bold text-center leading-tight overflow-hidden h-6 flex items-center justify-center w-full">{entry.user?.fullName || 'Гість'}</div>
                                            <div className="text-[9px] font-bold bg-white/50 px-1 rounded mt-0.5">Лб {entry.labNumber}</div>
                                        </>
                                    ) : <span className="text-gray-300 text-xl">+</span>}
                                </div>
                            )
                        })}
                    </div>

                    {selectedSlot && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-6" onClick={() => setSelectedSlot(null)}>
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">Слот #{selectedSlot.i}</h3>
                                {selectedSlot.entry ? (
                                    <>
                                        <p className="mb-2 text-lg">{selectedSlot.entry.user?.fullName}</p>
                                        <p className="text-sm text-gray-500 mb-4">Лабораторна №{selectedSlot.entry.labNumber}</p>
                                        {isAdmin && (
                                            <div className="space-y-3">
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={() => setStatus(selectedSlot.entry.userId, 'preparing')} className="p-2 bg-yellow-50 text-yellow-700 rounded-lg text-sm font-bold">Готується</button>
                                                    <button onClick={() => setStatus(selectedSlot.entry.userId, 'defending')} className="p-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold">Здає</button>
                                                    <button onClick={() => setStatus(selectedSlot.entry.userId, 'completed')} className="p-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-bold">Здав</button>
                                                    <button onClick={() => setStatus(selectedSlot.entry.userId, 'waiting')} className="p-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold">Очікує</button>
                                                </div>
                                                <button onClick={() => kick(selectedSlot.entry.userId)} className="w-full bg-red-100 text-red-600 py-2 rounded-lg font-bold">Видалити з черги</button>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <>
                                        {(queue.isActive || isAdmin) ? (
                                            <>
                                                <input type="number" placeholder="Номер лаби" className="w-full p-3 bg-gray-100 rounded-xl mb-4 text-center font-bold text-lg" value={labNum} onChange={e => setLabNum(e.target.value)} />
                                                <button onClick={() => join(selectedSlot.i)} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-2">Записатися</button>
                                                {isAdmin && (
                                                    <button onClick={() => { setIsAddUserOpen(true); setTargetSlot(selectedSlot.i); fetchUsers(); setSelectedSlot(null); }} className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                                        <Icons.UserPlus /> Додати студента
                                                    </button>
                                                )}
                                            </>
                                        ) : <p className="text-red-500 font-bold text-center">Черга закрита</p>}
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {isAddUserOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5 h-[80vh] flex flex-col">
                                <h3 className="font-bold mb-4">Оберіть студента (Слот #{targetSlot})</h3>
                                <input placeholder="Пошук..." className="p-2 border rounded-lg mb-4" value={searchUser} onChange={e => setSearchUser(e.target.value)} />
                                <div className="overflow-y-auto flex-1 space-y-2">
                                    {filteredUsers.map(u => (
                                        <div key={u._id} onClick={() => join(targetSlot, u._id)} className="p-3 bg-gray-50 rounded-lg font-bold active:bg-blue-100">
                                            {u.fullName}
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setIsAddUserOpen(false)} className="mt-4 p-3 bg-gray-100 rounded-xl font-bold">Скасувати</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Topics({ subject, user, isAdmin, onBack }) {
            const [topics, setTopics] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editTopic, setEditTopic] = useState(null);
            const [title, setTitle] = useState('');

            if (!subject) return <div className="p-10 text-center"><button onClick={onBack}>Назад</button></div>;

            const load = () => fetch(`${API}/topics/${subject._id}`).then(r => r.json()).then(setTopics);
            useEffect(() => { load(); }, []);

            const save = async () => {
                const url = editTopic ? `${API}/topics/${editTopic._id}` : `${API}/topics`;
                const method = editTopic ? 'PUT' : 'POST';
                await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ subjectId: subject._id, adminId: user.id, title }) });
                setIsModalOpen(false); load();
            };

            const del = async (id) => {
                if(confirm('Видалити тему?')) {
                    await fetch(`${API}/topics/${id}?adminId=${user.id}`, { method: 'DELETE' });
                    load();
                }
            };

            const toggle = async (t) => {
                if (!user || !user._mongoId) return alert("Зачекайте завантаження профілю...");
                await fetch(`${API}/topics/toggle`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ topicId: t._id, telegramId: user.id }) });
                load();
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4 animate-enter">
                    <div className="flex gap-3 mb-4 items-center justify-between">
                        <div className="flex gap-2 items-center">
                            <button onClick={onBack}><Icons.ArrowLeft /></button>
                            <h1 className="font-bold text-xl">Теми</h1>
                        </div>
                        {isAdmin && <button onClick={() => { setEditTopic(null); setTitle(''); setIsModalOpen(true); }} className="bg-blue-600 text-white p-2 rounded-lg"><Icons.Plus /></button>}
                    </div>
                    
                    <div className="space-y-3">
                        {topics.map(t => {
                            const myUser = user && user._mongoId && t.users?.some(u => u.userId === String(user._mongoId));
                            
                            return (
                                <div key={t._id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm relative">
                                    <div className="pr-8">
                                        <p className="font-medium text-gray-800 text-lg">{t.title}</p>
                                        {t.users?.length > 0 && (
                                            <div className="mt-2 flex flex-wrap gap-1">
                                                {t.users.map((u, idx) => (
                                                    <span key={idx} className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">{u.userName}</span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    
                                    <button onClick={() => toggle(t)} className={`mt-3 w-full py-2 rounded-lg font-bold text-sm ${myUser ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`}>
                                        {myUser ? 'Звільнити тему' : 'Зайняти тему'}
                                    </button>

                                    {isAdmin && (
                                        <div className="absolute top-2 right-2 flex gap-1">
                                            <button onClick={() => { setEditTopic(t); setTitle(t.title); setIsModalOpen(true); }} className="text-gray-400 p-1"><Icons.Edit /></button>
                                            <button onClick={() => del(t._id)} className="text-gray-400 p-1"><Icons.Trash /></button>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5">
                                <h3 className="font-bold mb-2">{editTopic ? 'Редагувати' : 'Нова тема'}</h3>
                                <textarea className="w-full p-2 border rounded-lg mb-4" rows="3" value={title} onChange={e => setTitle(e.target.value)}></textarea>
                                <div className="flex gap-2">
                                    <button onClick={save} className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">Зберегти</button>
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 bg-gray-100 rounded-lg">Скасувати</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        function Homework({ subject, user, isAdmin, onBack }) {
            const [hw, setHw] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editHw, setEditHw] = useState(null);
            const [form, setForm] = useState({ text: '', deadline: '' });
            
            if (!subject) return <div className="p-10 text-center"><button onClick={onBack}>Назад</button></div>;

            const load = () => fetch(`${API}/homework/${subject._id}`).then(r => r.json()).then(setHw);
            useEffect(() => { load(); }, []);

            const save = async () => {
                const url = editHw ? `${API}/homework/${editHw._id}` : `${API}/homework`;
                const method = editHw ? 'PUT' : 'POST';
                const body = { ...form, subjectId: subject._id, adminId: user.id, authorId: user.id };
                await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                setIsModalOpen(false); load();
            };

            const del = async (id) => {
                if(confirm('Видалити?')) {
                    await fetch(`${API}/homework/${id}?adminId=${user.id}`, { method: 'DELETE' });
                    load();
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4 animate-enter pb-24">
                     <div className="flex gap-3 mb-4 items-center justify-between">
                        <div className="flex gap-2 items-center">
                            <button onClick={onBack}><Icons.ArrowLeft /></button>
                            <h1 className="font-bold text-xl">Домашка</h1>
                        </div>
                        <button onClick={() => { setEditHw(null); setForm({text:'', deadline:''}); setIsModalOpen(true); }} className="bg-black text-white px-3 py-1 rounded-lg text-sm font-bold">+ Додати</button>
                    </div>

                    <div className="space-y-3">
                        {hw.map(h => (
                            <div key={h._id} className="bg-white p-4 rounded-xl border border-gray-200 relative">
                                <p className="text-gray-800 whitespace-pre-wrap">{h.text}</p>
                                <div className="flex justify-between items-center mt-3 pt-3 border-t border-dashed">
                                    <span className="text-xs font-bold bg-red-50 text-red-500 px-2 py-1 rounded">Дедлайн: {h.deadline || 'Не вказано'}</span>
                                    {isAdmin && (
                                        <div className="flex gap-2">
                                             <button onClick={() => { setEditHw(h); setForm({text: h.text, deadline: h.deadline}); setIsModalOpen(true); }} className="text-blue-400 text-xs font-bold">Ред.</button>
                                             <button onClick={() => del(h._id)} className="text-red-400 text-xs font-bold">Вид.</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5">
                                <h3 className="font-bold mb-2">{editHw ? 'Редагувати' : 'Нове завдання'}</h3>
                                <textarea className="w-full p-2 border rounded-lg mb-2 text-sm" rows="4" placeholder="Що задали?" value={form.text} onChange={e => setForm({...form, text: e.target.value})}></textarea>
                                <input type="date" className="w-full p-2 border rounded-lg text-sm mb-4" value={form.deadline} onChange={e => setForm({...form, deadline: e.target.value})} />
                                <div className="flex gap-2">
                                    <button onClick={save} className="flex-1 bg-black text-white py-2 rounded-lg font-bold">Зберегти</button>
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 bg-gray-100 rounded-lg">Скасувати</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )
        }

        function Schedule({ onNavigate }) {
            const [schedule, setSchedule] = useState(null);
            const [week, setWeek] = useState(1);
            const [error, setError] = useState(null);

            useEffect(() => { 
                fetch(`${API}/schedule`)
                    .then(r => r.json())
                    .then(data => {
                        if(data) setSchedule(data);
                        else setError('Помилка завантаження');
                    })
                    .catch(() => setError('Помилка')); 
            }, []);

            if (error) return <div className="p-10 text-center text-red-500 font-bold">{error}</div>;
            if (!schedule) return <div className="p-10 text-center">Завантаження розкладу...</div>;

            const weekKey = week === 1 ? 'scheduleFirstWeek' : 'scheduleSecondWeek';
            
            // Масив днів для ітерації (порядок відображення)
            const daysOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // Назви для заголовків
            const dayHeaders = { 
                Monday: 'Понеділок', Tuesday: 'Вівторок', Wednesday: 'Середа', 
                Thursday: 'Четвер', Friday: "П'ятниця", Saturday: "Субота" 
            };
            
            // Ключі, які повертає API (Cyrillic)
            const apiDayKeys = { 
                Monday: 'Пн', Tuesday: 'Вв', Wednesday: 'Ср', 
                Thursday: 'Чт', Friday: 'Пт', Saturday: 'Сб' 
            };

            return (
                <div className="p-4 pb-24 animate-enter">
                    <div className="flex bg-gray-200 p-1 rounded-xl mb-4">
                        <button onClick={() => setWeek(1)} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${week===1 ? 'bg-white shadow' : 'text-gray-500'}`}>1 Тиждень</button>
                        <button onClick={() => setWeek(2)} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${week===2 ? 'bg-white shadow' : 'text-gray-500'}`}>2 Тиждень</button>
                    </div>

                    <div className="space-y-6">
                        {daysOrder.map(dayCode => {
                            // Шукаємо день за кириличним ключем, який дає API
                            const dayData = schedule[weekKey].find(d => d.day === apiDayKeys[dayCode]);
                            
                            if (!dayData?.pairs?.length) return null;
                            
                            return (
                                <div key={dayCode}>
                                    <h3 className="text-gray-400 font-bold uppercase text-xs mb-2 pl-1">{dayHeaders[dayCode]}</h3>
                                    <div className="space-y-2">
                                        {dayData.pairs.map((pair, idx) => {
                                            const isLec = pair.type.includes('Лек');
                                            const isLab = pair.type.includes('Лаб');
                                            const color = isLec ? 'border-purple-500' : isLab ? 'border-blue-500' : 'border-orange-500';
                                            const bg = isLec ? 'bg-purple-50 text-purple-700' : isLab ? 'bg-blue-50 text-blue-700' : 'bg-orange-50 text-orange-700';
                                            
                                            return (
                                                <div key={idx} onClick={() => onNavigate('search_subject', pair.name)} className={`bg-white p-3 rounded-xl border-l-4 shadow-sm flex gap-3 ${color}`}>
                                                    <div className="font-bold text-gray-900 w-12 text-sm pt-1">{pair.time.substring(0, 5)}</div>
                                                    <div>
                                                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded uppercase ${bg}`}>{pair.type}</span>
                                                        <h4 className="font-bold text-gray-800 leading-tight my-1">{pair.name}</h4>
                                                        <p className="text-xs text-gray-500">{pair.teacherName}</p>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // --- ROOT APP ---
        function App() {
            const [history, setHistory] = useState([{ view: 'home', data: null }]);
            const [user, setUser] = useState(null);
            
            // ADMIN IDS
            const ADMIN_IDS = [1876094081, 1117478810]; 

            useEffect(() => {
                const tg = window.Telegram?.WebApp;
                if(tg) {
                    tg.ready(); tg.expand();
                    const u = tg.initDataUnsafe?.user;
                    if(u) {
                        fetch(`${API}/users/update`, { 
                            method: 'POST', 
                            headers: {'Content-Type': 'application/json'}, 
                            body: JSON.stringify({ telegramId: u.id, fullName: `${u.first_name} ${u.last_name||''}`.trim(), username: u.username }) 
                        });
                        
                        fetch(`${API}/users`).then(r => r.json()).then(users => {
                            const found = users.find(x => x.telegramId === u.id);
                            if(found) setUser({ ...u, _mongoId: found._id });
                            else setUser({ ...u, _mongoId: null }); 
                        });
                    }
                } else {
                    // Dev mock
                    setUser({ id: 1876094081, first_name: "Admin", _mongoId: "dev_id" });
                }
            }, []);

            const active = history[history.length - 1];

            const navigate = (view, data = null) => {
                if(view === 'search_subject') {
                    fetch(`${API}/subjects`).then(r => r.json()).then(subs => {
                        const found = subs.find(s => s.name.toLowerCase().includes(data.toLowerCase()) || data.toLowerCase().includes(s.name.toLowerCase()));
                        if(found) setHistory(prev => [...prev, { view: 'details', data: found }]);
                        else alert('Предмет не знайдено. Створіть його спочатку в розділі "Предмети".');
                    });
                    return;
                }
                setHistory(prev => [...prev, { view, data }]);
            };

            const back = () => {
                if (history.length > 1) {
                    setHistory(prev => prev.slice(0, -1));
                }
            };
            
            const goToTab = (view) => {
                setHistory([{ view, data: null }]);
            }

            useEffect(() => {
                const tg = window.Telegram?.WebApp;
                if (!tg) return;
                if (history.length > 1) {
                    tg.BackButton.show();
                    tg.BackButton.onClick(back);
                } else {
                    tg.BackButton.hide();
                    tg.BackButton.offClick(back);
                }
                return () => tg.BackButton.offClick(back);
            }, [history]);

            const isAdmin = user && ADMIN_IDS.includes(user.id);

            const render = () => {
                switch(active.view) {
                    case 'home': return <SubjectsList user={user} isAdmin={isAdmin} onNavigate={navigate} />;
                    case 'details': return <SubjectDetails subject={active.data} user={user} isAdmin={isAdmin} onNavigate={navigate} onBack={back} />;
                    case 'queue': return <Queue subject={active.data} user={user} isAdmin={isAdmin} onBack={back} />;
                    case 'topics': return <Topics subject={active.data} user={user} isAdmin={isAdmin} onBack={back} />;
                    case 'homework': return <Homework subject={active.data} user={user} isAdmin={isAdmin} onBack={back} />;
                    case 'schedule': return <Schedule onNavigate={navigate} />;
                    default: return <SubjectsList />;
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen font-sans text-gray-900 pb-20">
                    {render()}
                    
                    {history.length === 1 && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 pb-6 z-50">
                            <button onClick={() => goToTab('home')} className={`flex flex-col items-center p-2 rounded-xl w-20 transition ${active.view==='home'?'text-blue-600 bg-blue-50':'text-gray-400'}`}>
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                                <span className="text-[10px] font-bold mt-1">Предмети</span>
                            </button>
                            <button onClick={() => goToTab('schedule')} className={`flex flex-col items-center p-2 rounded-xl w-20 transition ${active.view==='schedule'?'text-blue-600 bg-blue-50':'text-gray-400'}`}>
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                <span className="text-[10px] font-bold mt-1">Розклад</span>
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>